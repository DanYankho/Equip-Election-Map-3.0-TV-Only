<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Malawi Election Map — TV-ready</title>

  <!-- D3 -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    /* ---------- Visuals ---------- */
    :root {
      --accent: #0d2136; /* gold accent */
      --ui: #222;
      --muted: #777;
      --panel-width: 340px;
      --tv-safe-margin: 7%; /* TV safe zone margin */
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #A7A7A7; /* WHITE background as requested */
      font-family: 'Libre Franklin', "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden; /* prevent scrollbars on big screens */
      color: #111;
    }

    /* Header overlay (small) */
    .header {
      position: absolute;
      top: 50px;
      left: var(--tv-safe-margin);
      transform: none; /* Removed the centering transform */
      z-index: 75; /* Increased z-index to be above dropdown */
      pointer-events: none;
      transition: opacity 300ms ease, visibility 300ms ease;
    }
    .header.hidden {
      opacity: 0;
      visibility: hidden;
    }
    .header h1 {
      margin: 0;
      padding: 12px 18px;
      font-size: 40px;
      color: var(--accent);
      background: rgba(255,255,255,0.85);
      max-width: 380px; /* Add this to limit maximum width */
      border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      font-weight: 700;
      pointer-events: auto; /* Changed to allow clicking */
      letter-spacing: 0.5px; /* Improved crispness on HD */
      cursor: pointer; /* Add pointer cursor */
      transition: background-color 0.2s ease;
    }
    
    .header h1:hover {
      background: rgba(255,255,255,0.95);
    }

    /* Years dropdown */
    .year-dropdown {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      background: #fff;
      border: 1px solid #ddd;
      min-width: 350px;
      border-radius: 6px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.08);
      padding: 8px;
      display: none;
      z-index: 80;
      pointer-events: auto;
    }
    .year-dropdown button {
      display: block;
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      padding: 8px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 16px;
    }
    .year-dropdown button:hover { background: rgba(0,0,0,0.04); }
    .year-dropdown button.active { background: var(--accent); color:#000; font-weight:700; }
    
    /* Keyboard mode toggle */
    .keyboard-mode {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    .keyboard-mode label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--accent);
    }
    .keyboard-mode-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .keyboard-mode-options button {
      text-align: left;
      padding: 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
    .keyboard-mode-options button.active {
      background: var(--accent);
      color: white;
      font-weight: 600;
    }
    .keyboard-mode-options button:hover:not(.active) {
      background: rgba(0,0,0,0.04);
    }

    /* Map container - LARGER SIZE */
    #map-root {
      position: absolute;
      width: 100vw;
      height: 100vh;
      left: 0;
      top: 0;
      overflow: hidden;
    }
    svg { 
      width: 100%; 
      height: 100%; 
      display:block; 
    }

    /* District, lake styles */
    .district {
      stroke: #333;
      stroke-width: 5px; /* Thicker for TV visibility */
      cursor: pointer;
      transition: stroke-width 120ms ease, filter 120ms ease, opacity 120ms ease;
      paint-order: stroke; /* keep stroke visible */
    }
    .district:hover { stroke-width: 2px; filter: drop-shadow(0 2px 10px rgba(0,0,0,0.08)); }
    .lake {
      fill: #cfe9ff;
      stroke: #9fc7ee;
      stroke-width: 0.4px;
    }
    .faded { opacity: 0.12; }
    .focused { 
      stroke-width: 1px; 
      filter: drop-shadow(0 2px 14px rgba(255,215,0,0.6));
      z-index: 10;
    }

    /* District labels */
    .district-label {
      font-size: 12px;
      font-weight: bold;
      fill: #333;
      text-anchor: middle;
      pointer-events: none;
      user-select: none;
      transition: opacity 300ms ease;
    }
    .district-label.hidden {
      opacity: 0;
    }

    /* Info panel on left side */
    .info-panel {
      position: absolute;
      left: var(--tv-safe-margin);
      top: 50%;
      transform: translateY(-50%);
      width: 350px;
      max-height: 80vh;
      background: #ffffff;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      z-index: 90;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transition: opacity 300ms ease, visibility 300ms ease;
    }
    .info-panel.visible { 
      opacity: 1; 
      visibility: visible;
    }
    .info-panel .title { 
      color: var(--accent); 
      font-weight: 700; 
      margin-bottom: 10px; 
      font-size: 61px;
      border-bottom: 2px solid var(--accent);
      padding-bottom: 8px;
      letter-spacing: 0.5px; /* Improved crispness on HD */
    }
    .info-panel .meta { 
      color: #444; 
      margin-bottom: 16px; 
      font-size: 30px;
      font-weight: 500;
    }
    .info-panel table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 20px;
      margin-top: 15px;
    }
    .info-panel .party-label {
      display: block;
      font-size: 16px;
      color: #777;
      font-weight: 500;
      margin-left: 0;
      margin-top: 4px;
    }
    .info-panel tr { 
      border-bottom: 1px solid #eee;
      position: relative;
    }
    .info-panel tr:last-child {
      border-bottom: none;
    }
    .info-panel tr td { 
      padding: 10px 8px; 
      vertical-align: middle; 
      position: relative;
      z-index: 1;
    }
    .winner-badge {
      display: inline-block;
      background: #FFF;
      color: #0D2136;
      font-weight: bold;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 8px;
      box-shadow: 0 1px 10px rgba(0,0,0,0.2);
    }

    .zoom-button:hover {
      transform: scale(1.1);
      background: #0a1a2b;
    }

    /* Stats panels */
    .stats-panel {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 20px; /* Increased padding for TV */
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      z-index: 60;
      max-height: 40vh;
      overflow-y: auto;
      border: 1px solid rgba(0,0,0,0.08);
      transition: opacity 300ms ease, visibility 300ms ease;
    }
    
    .candidate-stats {
      right: var(--tv-safe-margin);
      top: 50px; /* Adjusted for TV safe zone */
      width: 350px; /* Increased width for party labels */
      height: 80%; /* Increased height to fit 5 parties comfortably */
      max-height: max-content; /* Prevent it from growing beyond 5 parties */
      
    }
    
    .party-stats {
      top: 250px;
      left: var(--tv-safe-margin);
      font-size: 30px;
      width: 280px;
      height: 300px; /* Increased height to fit 5 parties comfortably */
      max-height: 300px; /* Prevent it from growing beyond 5 parties */
      overflow-y: auto; /* Add scroll if there are more than 5 parties */
    }
    
    .stats-panel.faded {
      opacity: 0;
      visibility: hidden;
    }
    
    .stats-title {
      color: var(--accent);
      font-weight: 700;
      margin-bottom: 12px;
      font-size: 40px;
      border-bottom: 1px solid var(--accent);
      padding-bottom: 6px;
      letter-spacing: 0.5px; /* Improved crispness on HD */
    }
    
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 20px; /* Increased font size for TV */
    }
    
    .stats-table tr {
      border-bottom: 1px solid #eee;
      position: relative;
    }
    
    .stats-table tr:last-child {
      border-bottom: none;
    }
    
    .stats-table td {
      padding: 12px 8px; /* Increased padding for TV */
      vertical-align: middle;
      position: relative;
      z-index: 1;
    }
    
    .stats-table .percentage {
      text-align: right;
      color: #333; /* Darker for better contrast */
      font-weight: 700; /* Bolder for emphasis */
      padding-right: 5px; /* Added spacing */
      font-size: 22px; /* Larger percentage numbers */
    }
    
    .stats-table .votes {
      text-align: right;
      color: #202020; /* Better contrast */
      font-size: 18px; /* Larger for TV */
      padding-right: 5px;
    }
    
    .stats-table .party-label {
      display: block;
      font-size: 16px;
      color: #777;
      font-weight: 500;
      margin-left: 0;
      margin-top: 4px;
    }

    /* Party swatch - only for districts won panel */
    .party-swatch { 
      width: 16px; 
      height: 16px; 
      display: inline-block; 
      border-radius: 4px; 
      margin-right: 10px; 
      border: 1px solid rgba(0,0,0,0.1); 
    }

    /* Percentage bars - background version */
    .percentage-bar-container {
      position: absolute;
      top: 2px;
      left: 2px;
      width: calc(100% - 4px);
      height: calc(100% - 20px);
      border-radius: 4px;
      overflow: hidden;
      z-index: 0;
      background: linear-gradient(90deg, rgba(0,0,0,0.03) 0%, rgba(0,0,0,0.01) 100%); /* Subtle gradient */
    }
    
    .percentage-bar {
      height: 100%;
      border-radius: 8px;
      opacity: 0.5;
      transition: width 0.5s ease;
    }

    /* Loading indicator */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Keyboard shortcut hint */
    .keyboard-hint {
      position: absolute;
      bottom: 10%;
      left: var(--tv-safe-margin);
      background: rgba(255, 255, 255, 0.85);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 16px;
      z-index: 50;
      box-shadow: 0 4px 12px rgba(0,0,0,0.9);
      transition: opacity 0.3s ease;
    }
    .keyboard-hint.faded {
      opacity: 0;
      pointer-events: none;
    }

    /* Two-digit input indicator */
    .input-indicator {
      position: absolute;
      bottom: calc(var(--tv-safe-margin) + 60px);
      left: var(--tv-safe-margin);
      background: rgba(255, 255, 255, 0.85);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 16px;
      z-index: 50;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: none;
    }
    .input-indicator .digits {
      font-weight: bold;
      color: var(--accent);
      margin: 0 5px;
    }

    /* Remove mobile-specific styles */
    @media (max-width: 900px) {
      /* All mobile-specific styles removed */
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 id="page-title">Malawi Presidential Election Results</h1>
    <div id="yearDropdown" class="year-dropdown" role="menu" aria-hidden="true"></div>
  </div>

  <div id="map-root" role="application" aria-label="Malawi map">
    <svg id="map-svg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet"></svg>
    <div id="info-panel" class="info-panel" role="dialog" aria-hidden="true"></div>
    
    <!-- New stats panels -->
    <div id="candidate-stats" class="stats-panel candidate-stats">
      <div class="stats-title">Total Votes</div>
      <table class="stats-table" id="candidate-table">
        <!-- Will be populated dynamically -->
      </table>
    </div>
    
    <div id="party-stats" class="stats-panel party-stats">
      <div class="stats-title">Districts Won</div>
      <table class="stats-table" id="party-table">
        <!-- Will be populated dynamically -->
      </table>
    </div>
    
    <div id="loading" class="loading" style="display: none;">
      <div class="loading-spinner"></div>
      <span>Loading data...</span>
    </div>
    
    <button id="likoma-button" class="zoom-button" aria-label="Focus on Likoma Island">
      L
    </button>

    <div class="keyboard-hint">
      <div class="keyboard-hint-content">
        <div class="keyboard-hint-text">*Unofficial results for 2025*</div>
        <div class="keyboard-hint-bar">
          <div class="keyboard-hint-progress" style="width: 50%;"></div>
        </div>
      </div>
    </div>
    
    <div class="input-indicator">
      Year: <span class="digits"></span>
    </div>
  </div>

<script>
/* ========= FULL SCRIPT =========
   - click toggles zoom in/out for district
   - district info appears in left panel
   - year selection via dropdown
   - white background
   - loads malawi_districts.geojson and CSVs per year
   - Added candidate and party stats panels
   - Added keyboard controls for year switching
   - Header hides when district is selected
   - Added two-digit year input option
   - Added district labels with abbreviations
   - Labels are hidden when district is selected and zoomed in
*/


(async function(){

  // ---------- CONFIG ----------
  const years = ["1994","1999","2004","2009","2014","2019","2020","2025"];
  let currentYear = years[0];

  // District abbreviations mapping
  const districtAbbreviations = {
    "CHITIPA": "CT",
    "KARONGA": "KA",
    "LIKOMA": " ",
    "MZIMBA": "MZ",
    "NKHATA BAY": "NB",
    "RUMPHI": "RU",
    "DEDZA": "DZ",
    "DOWA": "DO",
    "KASUNGU": "KU",
    "LILONGWE": "LL",
    "MCHINJI": "MI",
    "NKHOTAKOTA": "KK",
    "NENO": "NE",
    "NTCHEU": "NT",
    "NTCHISI": "NC",
    "SALIMA": "SA",
    "BALAKA": "BK",
    "BLANTYRE": "BT",
    "CHIKWAWA": "CK",
    "CHIRADZULU": "CR",
    "MACHINGA": "MA",
    "MANGOCHI": "MG",
    "MULANJE": "MU",
    "MWANZA": "MW",
    "NSANJE": "NS",
    "PHALOMBE": "PH",
    "THYOLO": "TH",
    "ZOMBA": "ZA"
  };

  // Helper function to get district abbreviation
  function getDistrictAbbreviation(districtName) {
    const normalized = normalizeName(districtName);
    return districtAbbreviations[normalized] || normalized.substring(0, 2);
  }

  // Keyboard mode state
  let keyboardMode = "digits"; // "digits" or "numbers"
  let digitInput = "";
  let digitTimeout = null;

  // SVG & container
  const mapRoot = document.getElementById("map-root");
  const svg = d3.select("#map-svg");
  let width = mapRoot.clientWidth, height = mapRoot.clientHeight;
  svg.attr("viewBox", `0 0 ${width} ${height}`);

  // Map group for zoom transforms
  const mapGroup = svg.append("g").attr("id", "mapGroup");

  // Info panel
  const infoPanel = d3.select("#info-panel");

  // Header element
  const header = d3.select(".header");

  // Stats panels
  const candidateStats = d3.select("#candidate-stats");
  const partyStats = d3.select("#party-stats");

  // Keyboard hint
  const keyboardHint = d3.select(".keyboard-hint");

  // Input indicator
  const inputIndicator = d3.select(".input-indicator");
  const inputDigits = inputIndicator.select(".digits");

  // Loading indicator
  const loadingIndicator = d3.select("#loading");

  // Projection & path - ADJUSTED FOR LARGER MAP
  const projection = d3.geoMercator()
    .center([34.3015, -13.2543])
    .scale(Math.min(width, height) * 6.5)  // Increased scale for larger map
    .translate([width / 2, height / 2]);
  
  const path = d3.geoPath().projection(projection);

  // State
  let geoData = null;
  let districtSelection = null;
  let lakeSelection = null;
  let labelSelection = null;
  let zoomBehavior = null;
  let allElectionData = {}; // { year: { electionData, partyColors } }
  let selectedFeature = null; // currently zoomed/selected feature
  let selectedFeatureId = null;

  // Performance optimization cache
  const centroidCache = new Map();
  let resizeTimeout = null;
  let hintTimeout = null;

  // Normalize function
  function normalizeName(name){
    if(!name || typeof name !== 'string') return '';
    return name.trim().toUpperCase().replace(/\s+/g, ' ');
  }

  // Robust feature district name extraction (tries many properties)
  function featureDistrictName(feat){
    const p = feat && feat.properties ? feat.properties : {};
    const keys = ['NAME_1','NAME','DISTRICT','Dist_Name','DISTRICT NAME','DISTNAME','DIST_NAME','district','District'];
    for(const k of keys){
      if(p[k] && typeof p[k] === 'string' && p[k].trim().length) return p[k];
    }
    // fallback to `id` or index
    return p.NAME_1 || p.DISTRICT || p.name || p.id || '';
  }

  // Add these cache variables near the top of your script with other state variables
  let dataCache = {};
  let lastFetchTime = {};

  // ---------- Loading CSV data for a year ----------
  async function loadElectionData(year) {
    // Check cache first (cache for 2 minutes to avoid hitting Google Sheets limits)
    const now = Date.now();
    if (dataCache[year] && lastFetchTime[year] && (now - lastFetchTime[year] < 120000)) {
      console.log(`Using cached data for ${year}`);
      return dataCache[year];
    }

    let url;

    // Use Google Sheets URL for 2025, local CSVs for other years
    if (year === "2025") {
      // Direct CSV export link
      url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSuZ4RHNfsq6JMIbJhvxtSYANk5e7DNtqCLAu45msrx0Am2PyX7enT6yLyBCkOB5BXmTta104a6AMA4/pub?gid=1682262614&single=true&output=csv";
    } else {
      const cacheBuster = new Date().getTime();
      url = `data/${year}presRegional.csv?t=${cacheBuster}`;
    }

    try {
      console.log(`Loading data for ${year} from: ${url}`);
      const rows = await d3.csv(url);
      const electionData = {};
      const partyColors = {};

      rows.forEach(r => {
        // robust column matching
        const districtRaw = r["DISTRICT NAME"] || r["DISTRICT"] || r["District"] || r["DIST_NAME"] || r["NAME_1"] || "";
        const candRaw = r["NAME OF CANDIDATE"] || r["CANDIDATE"] || r["NAME"] || "";
        const partyRaw = r["PARTY"] || r["PARTY NAME"] || r["Party"] || "";
        const partyAbbr = r["PARTY ABBR"] || r["PARTY_ABBR"] || r["ABBR"] || partyRaw;
        const colorRaw = r["PARTY COLOR"] || r["PARTY_COLOR"] || r["COLOR"] || "";
        const votesRaw = r["VOTES SCORED"] || r["VOTES"] || r["Votes"] || r["VOTES_SCORED"] || "0";

        const district = normalizeName(districtRaw);
        const candidate = (candRaw || "").trim();
        const party = (partyRaw || "").trim();
        const partyAbbreviation = (partyAbbr || "").trim();
        const color = (colorRaw && colorRaw.trim()) ? colorRaw.trim() : "#999999";
        let votes = 0;
        try { votes = parseInt((votesRaw || "0").toString().replace(/,/g, ''), 10) || 0; } catch (e) { votes = 0; }

        if (!district) return;

        partyColors[party] = partyColors[party] || { color: color, abbreviation: partyAbbreviation };

        if (!electionData[district]) electionData[district] = { candidates: {}, color: color };
        if (!electionData[district].candidates[candidate]) {
          electionData[district].candidates[candidate] = {
            name: candidate,
            party: party,
            partyAbbr: partyAbbreviation,
            votes: 0,
            color: color
          };
        }
        electionData[district].candidates[candidate].votes += votes;
      });

      // convert candidates into sorted array and pick winner color
      Object.keys(electionData).forEach(k => {
        const arr = Object.values(electionData[k].candidates);
        arr.sort((a, b) => b.votes - a.votes);

        // Calculate vote percentages for each candidate
        const totalVotes = arr.reduce((sum, c) => sum + c.votes, 0);
        arr.forEach(candidate => {
          candidate.percentage = totalVotes > 0 ?
            Math.round((candidate.votes / totalVotes) * 100) : 0;
        });

        electionData[k].candidates = arr;
        if (arr.length > 0) electionData[k].color = arr[0].color || electionData[k].color;
      });

      // Store in cache
      const result = { electionData, partyColors };
      dataCache[year] = result;
      lastFetchTime[year] = now;

      console.log(`Successfully loaded data for ${year}`);
      return result;

    } catch (err) {
      console.warn(`Failed to load CSV for ${year} (${url})`, err);

      // If we have cached data, return it even if fresh fetch failed
      if (dataCache[year]) {
        console.log(`Returning cached data due to fetch error`);
        return dataCache[year];
      }

      return { electionData: {}, partyColors: {} }; // return empty so map still loads
    }
  }

  // Function to find Likoma feature
  function findLikomaFeature() {
    if (!geoData || !geoData.features) return null;
    
    return geoData.features.find(feature => {
      const name = featureDistrictName(feature);
      return normalizeName(name) === "LIKOMA";
    });
  }

  // Function to focus on Likoma
  function focusOnLikoma() {
    const likomaFeature = findLikomaFeature();
    if (!likomaFeature) return;
    
    // If already focused on Likoma, reset view
    if (selectedFeatureId === "LIKOMA") {
      resetView();
      return;
    }
    
    // Select Likoma
    selectedFeature = likomaFeature;
    selectedFeatureId = "LIKOMA";
    
    // Hide header
    header.classed("hidden", true);
    
    // Focus/zoom to Likoma
    focusOnFeature(likomaFeature);
    
    // Fade other districts, highlight Likoma
    districtSelection.classed("faded", true);
    districtSelection.filter(d => {
      const name = normalizeName(featureDistrictName(d));
      return name === "LIKOMA";
    }).classed("faded", false).classed("focused", true).raise();
    
    // Hide labels
    labelSelection.classed("hidden", true);
    
    // Hide right panels
    candidateStats.classed("faded", true);
    partyStats.classed("faded", true);
    
    // Build info panel content
    infoPanel.html(buildInfoPanelHtml(likomaFeature, currentYear))
              .classed("visible", true)
              .attr("aria-hidden", "false");
  }

  // ---------- Update candidate and party stats ----------
  function updateStatsPanels(year) {
    const dataset = allElectionData[year] || { electionData: {}, partyColors: {} };
    const ed = dataset.electionData || {};
    
    // Calculate candidate totals
    const candidateTotals = {};
    const partyDistricts = {};
    const totalDistricts = Object.keys(ed).length;
    
    // Process each district
    Object.keys(ed).forEach(district => {
      const districtData = ed[district];
      
      // Skip districts with no candidates or all zero votes
      if (!districtData.candidates || districtData.candidates.length === 0) {
        return;
      }
      
      // Check if all votes are zero in this district
      const allZero = districtData.candidates.every(candidate => candidate.votes === 0);
      if (allZero) {
        return; // Skip this district
      }
      
      // Count districts won by each party (only if votes > 0)
      if (districtData.candidates && districtData.candidates.length > 0) {
        const winningCandidate = districtData.candidates[0];
        const winningParty = winningCandidate.party;
        partyDistricts[winningParty] = (partyDistricts[winningParty] || 0) + 1;
      }
      
      // Sum votes for each candidate
      if (districtData.candidates) {
        districtData.candidates.forEach(candidate => {
          if (!candidateTotals[candidate.name]) {
            candidateTotals[candidate.name] = {
              votes: 0,
              party: candidate.party,
              partyAbbr: candidate.partyAbbr,
              color: candidate.color
            };
          }
          candidateTotals[candidate.name].votes += candidate.votes;
        });
      }
    });
    
    // Convert to arrays and sort
    const candidateArray = Object.keys(candidateTotals).map(name => ({
      name,
      votes: candidateTotals[name].votes,
      party: candidateTotals[name].party,
      partyAbbr: candidateTotals[name].partyAbbr,
      color: candidateTotals[name].color
    })).sort((a, b) => b.votes - a.votes);
    
    const totalVotes = candidateArray.reduce((sum, c) => sum + c.votes, 0);
    
    // Calculate percentages
    candidateArray.forEach(candidate => {
      candidate.percentage = totalVotes > 0 ? 
        Math.round((candidate.votes / totalVotes) * 100) : 0;
    });
    
    // Update candidate stats table
    const candidateTable = d3.select("#candidate-table");
    candidateTable.selectAll("*").remove();
    
    candidateArray.forEach(candidate => {
      if (candidate.votes > 0) {
        const row = candidateTable.append("tr");
        
        // Add percentage bar as background
        row.append("td")
          .attr("colspan", 4)
          .style("position", "absolute")
          .style("top", "2px")
          .style("left", "2px")
          .style("width", "calc(100% - 4px)")
          .style("height", "calc(100% - 4px)")
          .style("z-index", "0")
          .html(`<div class="percentage-bar-container"><div class="percentage-bar" style="width: ${candidate.percentage}%; background-color: ${candidate.color || '#888'}"></div></div>`);
        
        // Candidate name with party abbreviation
        row.append("td")
          .html(`${candidate.name} <span class="party-label">${candidate.partyAbbr || candidate.party}</span>`)
          .style("font-weight", "700"); // Bolder for TV
        
        // Percentage
        row.append("td").attr("class", "percentage")
          .text(`${candidate.percentage}%`);
        
        // Vote count
        row.append("td").attr("class", "votes")
          .text(candidate.votes.toLocaleString());
      }
    });
    
    // Update party stats table - REMOVED PERCENTAGES
    const partyTable = d3.select("#party-table");
    partyTable.selectAll("*").remove();
    
    // Convert to array and sort by districts won
    const partyArray = Object.keys(partyDistricts)
      .map(party => ({
        party,
        districts: partyDistricts[party],
        color: dataset.partyColors[party]?.color || "#999999",
        abbreviation: dataset.partyColors[party]?.abbreviation || party
      }))
      .sort((a, b) => b.districts - a.districts);
    
    partyArray.forEach(party => {
      const row = partyTable.append("tr");
      // Party color swatch (only for districts won panel)
      row.append("td").html(`<span class="party-swatch" style="background:${party.color}"></span>`);
      row.append("td").text(party.abbreviation).style("font-weight", "700"); // Bolder for TV
      row.append("td").attr("class", "percentage").text(party.districts); // Only show district count, no percentage
    });
  }

  // ---------- UI: populate years dropdown ----------
  const yearDropdown = d3.select("#yearDropdown");
  function buildYearList(){
    yearDropdown.selectAll("*").remove();
    years.forEach(y => {
      yearDropdown.append("button")
        .attr("type","button")
        .classed("year-item", true)
        .classed("active", y === currentYear)
        .text(y)
        .on("click", function(){
          setYear(y);
        });
    });
    
    // Add keyboard mode selector at the bottom
    const modeSection = yearDropdown.append("div")
      .attr("class", "keyboard-mode");
      
    modeSection.append("label")
      .text("Keyboard Input Mode:");
      
    const modeOptions = modeSection.append("div")
      .attr("class", "keyboard-mode-options");
      
    modeOptions.append("button")
      .attr("type", "button")
      .classed("active", keyboardMode === "numbers")
      .text("Number keys 1-8")
      .on("click", function() {
        setKeyboardMode("numbers");
        hideYearDropdown();
      });
      
    modeOptions.append("button")
      .attr("type", "button")
      .classed("active", keyboardMode === "digits")
      .text("Type last 2 digits (e.g., '99' for 1999)")
      .on("click", function() {
        setKeyboardMode("digits");
        hideYearDropdown();
      });
  }
  buildYearList();

  // Set keyboard mode function
  function setKeyboardMode(mode) {
    keyboardMode = mode;
    digitInput = ""; // Reset any partial input
    
    // Update UI
    yearDropdown.selectAll(".keyboard-mode-options button")
      .classed("active", function() {
        const buttonText = d3.select(this).text();
        return (mode === "numbers" && buttonText.includes("1-8")) ||
               (mode === "digits" && buttonText.includes("last 2 digits"));
      });
      
    // Update keyboard hint
    updateKeyboardHint();
  }

  // Update keyboard hint based on current mode
  function updateKeyboardHint() {
    if (keyboardMode === "numbers") {
      keyboardHint.select(".keyboard-hint-text").html("Press 1-8 to switch years, Esc to reset view");
    } else {
      keyboardHint.select(".keyboard-hint-text").html("Type last 2 digits of year (e.g., '99' for 1999), Esc to reset view.<br>Tap on district to view district votes, Type L to view Likoma");
    }
  }

  // Make header clickable for dropdown
  d3.select("#page-title").on("click", function(){
    const expanded = yearDropdown.style("display") === "block";
    if(expanded) hideYearDropdown(); else showYearDropdown();
  });

  function showYearDropdown(){
    yearDropdown.style("display","block").attr("aria-hidden","false");
  }
  function hideYearDropdown(){
    yearDropdown.style("display","none").attr("aria-hidden","true");
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(event) {
    const isClickInsideHeader = event.target.closest('.header');
    if (!isClickInsideHeader) {
      hideYearDropdown();
    }
  });

  // ---------- Projection sizing ----------
  function updateProjection(){
    width = mapRoot.clientWidth;
    height = mapRoot.clientHeight;
    svg.attr("viewBox", `0 0 ${width} ${height}`);
    // Increased scale for larger map display
    projection.scale(Math.min(width, height) * 6.5)
              .translate([width / 2, height / 2]);
    path.projection(projection);
  }

   // ---------- Info panel builder with vote percentages ----------
  function buildInfoPanelHtml(feature, year){
    const dnameRaw = featureDistrictName(feature);
    const dname = normalizeName(dnameRaw);
    const dataset = allElectionData[year] || { electionData: {} };
    const districtData = dataset.electionData[dname];

    let html = `<div class="title">${escapeHtml(dnameRaw || "Unknown District")}</div>`;
    if(!districtData || !districtData.candidates || districtData.candidates.length === 0){
      html += `<div class="meta">No election data available for ${escapeHtml(year)}</div>`;
      return html;
    }
    
    // Check if all votes are zero
    const allZero = districtData.candidates.every(candidate => candidate.votes === 0);
    if (allZero) {
      html += `<div class="meta">No votes recorded for ${escapeHtml(year)}</div>`;
      return html;
    }
    
    html += `<div class="meta">District votes (${escapeHtml(year)})</div><table>`;
    districtData.candidates.forEach((c, i) => {
      const isWinner = i === 0;
      
      html += `
        <tr>
          <td colspan="4" style="position: absolute; left: 2px; width: calc(100% - 4px); height: calc(100% - 4px); z-index: 0;">
            <div class="percentage-bar-container">
              <div class="percentage-bar" style="width: ${c.percentage}%; background-color: ${c.color || '#888'}"></div>
            </div>
          </td>
          <td style="font-weight:700">${escapeHtml(c.name || '')}${isWinner ? '<span class="winner-badge">WINNER</span>' : ''} <span class="party-label">${c.partyAbbr || c.party}</span></td>
          <td style="text-align:right; color:#333; width:60px; font-weight:700">${c.percentage}%</td>
          <td style="text-align:right; color:#666; width:80px; font-size:16px">${(c.votes||0).toLocaleString()}</td>
        </tr>`;
    });
    html += `</table>`;
    return html;
  }

  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch])); }

  // ---------- Update fills for current year ----------
  function updateMapForYear(year){
      const dataset = allElectionData[year] || { electionData: {}, partyColors: {} };
      const ed = dataset.electionData || {};
      if(!districtSelection) return;
      districtSelection.transition().duration(220)
        .attr("fill", d => {
          const dName = normalizeName(featureDistrictName(d));
          const districtData = ed[dName];
          
          // Check if district exists and has candidates
          if (!districtData || !districtData.candidates || districtData.candidates.length === 0) {
            return "#f5f5f5"; // Light gray for no data
          }
          
          // Check if all votes are zero
          const allZero = districtData.candidates.every(candidate => candidate.votes === 0);
          if (allZero) {
            return "#f5f5f5"; // Light gray for zero votes
          }
          
          return districtData.color || "#bdbdbd"; // Normal party color
        });
  }

  // ---------- Zooming behavior (mapGroup transforms) ----------
  function initZoom(){
    zoomBehavior = d3.zoom()
      .scaleExtent([1, 12])  // Increased maximum zoom for larger map
      .on("zoom", (event) => {
        mapGroup.attr("transform", event.transform);
      });
    svg.call(zoomBehavior);
  }

  // Programmatic focus on feature (compute bounds & set transform)
  function focusOnFeature(feature){
    const bounds = path.bounds(feature); // returns [[x0,y0],[x1,y1]] in current projection coords
    const dx = bounds[1][0] - bounds[0][0];
    const dy = bounds[1][1] - bounds[0][1];
    const x = (bounds[0][0] + bounds[1][0]) / 2;
    const y = (bounds[0][1] + bounds[1][1]) / 2;
    
    // Zoom to the right side of the screen
    const scale = Math.max(1, Math.min(12, 0.9 / Math.max(dx / (width * 0.6), dy / height))); // Adjusted for right-side focus
    const translate = [width * 0.65 - scale * x, height / 2 - scale * y]; // Focus on right side

    svg.transition().duration(2400).call(zoomBehavior.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)); // Faster transition for TV
  }

  function resetView(){
    selectedFeature = null;
    selectedFeatureId = null;
    svg.transition().duration(1800).call(zoomBehavior.transform, d3.zoomIdentity);
    
    // remove classes from all districts
    if(districtSelection) {
      districtSelection.classed("faded", false).classed("focused", false);
    }
  
    // Show labels again
    if(labelSelection) {
      labelSelection.classed("hidden", false);
    }
    
    infoPanel.classed("visible", false).attr("aria-hidden","true");
    
    // Show header again
    header.classed("hidden", false);
    
    // Show right panels again
    candidateStats.classed("faded", false);
    partyStats.classed("faded", false);
  }
  
  // ---------- Click handler (toggle zoom) ----------
  function onDistrictClick(event, d){
    // if this feature is already selected, zoom out
    const id = d.id || (d.properties && (d.properties.id || d.properties.NAME_1 || d.properties.DISTRICT)) || null;

    if(selectedFeature && selectedFeatureId === id){
      // toggle off
      resetView();
      return;
    }

    // else focus this feature
    selectedFeature = d;
    selectedFeatureId = id;

    // Hide header when district is selected
    header.classed("hidden", true);

    // focus / zoom to right side
    focusOnFeature(d);

    // fade others, highlight this
    districtSelection.classed("faded", dd => dd !== d);
    d3.select(this).classed("faded", false).classed("focused", true).raise();

    // Hide labels
    labelSelection.classed("hidden", true);

    // Hide right panels
    candidateStats.classed("faded", true);
    partyStats.classed("faded", true);

    // Add subtle pulse animation to selected district
    d3.select(this).transition()
      .duration(1000)
      .attr("filter", "url(#pulseEffect)")
      .transition()
      .duration(1000)
      .attr("filter", null);

    // build info panel content
    infoPanel.html(buildInfoPanelHtml(d, currentYear)).classed("visible", true).attr("aria-hidden","false");
  }

  // ---------- Set year function (used by both UI and keyboard) ----------
  function setYear(year) {
    if (!years.includes(year)) return;
    
    currentYear = year;
    // mark active visually
    yearDropdown.selectAll("button").classed("active", d => false);
    yearDropdown.selectAll("button").filter(d => d === year).classed("active", true);
    // update header text
    d3.select("#page-title").text(`Malawi Presidential Election — ${year}`);
    // update map colors
    updateMapForYear(currentYear);
    // update stats panels
    updateStatsPanels(currentYear);
    // close dropdown
    hideYearDropdown();
    // reset view so colors show across full map
    resetView();
  }

  // Process two-digit input
  function processDigitInput(digit) {
    // Clear any existing timeout
    if (digitTimeout) {
      clearTimeout(digitTimeout);
    }
    
    // Add the digit to our input
    digitInput += digit;
    inputDigits.text(digitInput);
    
    // Show the input indicator
    inputIndicator.style("display", "block");
    
    // If we have two digits, try to find a matching year
    if (digitInput.length === 2) {
      // Find the year that ends with these digits
      const matchedYear = years.find(y => y.endsWith(digitInput));
      
      if (matchedYear) {
        setYear(matchedYear);
        digitInput = "";
        inputIndicator.style("display", "none");
      } else {
        // Flash red to indicate invalid input
        inputIndicator.style("background", "rgba(255, 200, 200, 0.85)");
        setTimeout(() => {
          inputIndicator.style("background", "rgba(255, 255, 255, 0.85)");
        }, 300);
      }
      
      // Reset after a short delay
      digitTimeout = setTimeout(() => {
        digitInput = "";
        inputIndicator.style("display", "none");
      }, 1000);
    } else {
      // Set timeout to reset if no second digit is entered
      digitTimeout = setTimeout(() => {
        digitInput = "";
        inputIndicator.style("display", "none");
      }, 2000);
    }
  }

  // ---------- Keyboard controls ----------
  function setupKeyboardControls() {
    document.addEventListener('keydown', (e) => {
      // Always allow Escape to reset view
      if (e.key === "Escape") {
        resetView();
        return;
      }
      
      // Process based on current keyboard mode
      if (keyboardMode === "numbers") {
        // Number keys 1-8 for direct year selection
        if (e.key >= '1' && e.key <= '8') {
          const yearIndex = parseInt(e.key) - 1;
          if (yearIndex < years.length) {
            setYear(years[yearIndex]);
            
            // Show keyboard hint briefly
            keyboardHint.classed("faded", false);
            clearTimeout(hintTimeout);
            hintTimeout = setTimeout(() => {
              keyboardHint.classed("faded", true);
            }, 2000);
          }
        }
      } else if (keyboardMode === "digits") {
        // Two-digit input mode
        if (e.key >= '0' && e.key <= '9') {
          processDigitInput(e.key);
          
          // Show keyboard hint briefly
          keyboardHint.classed("faded", false);
          clearTimeout(hintTimeout);
          hintTimeout = setTimeout(() => {
            keyboardHint.classed("faded", true);
          }, 2000);
        }
      }
      
      // 'L' key for Likoma focus
      if (e.key === 'l' || e.key === 'L') {
        focusOnLikoma();
      }
    });
  }

  // ---------- Load geojson + CSVs and draw map ----------
  try {
    // Show loading indicator
    loadingIndicator.style("display", "flex");
    
    // 1) load geojson
    const geo = await d3.json("data/malawi_districts.geojson");
    geoData = geo;

    // 2) load CSVs for all years in parallel
    const csvPromises = years.map(y => loadElectionData(y));
    const results = await Promise.all(csvPromises);
    years.forEach((y,i) => allElectionData[y] = results[i] || { electionData: {}, partyColors: {} });

    // 3) prepare projection and path
    updateProjection();

    // 4) separate lakes (heuristic) and districts
    function isLake(f){
      const p = f.properties || {};
      const t = (p.TYPE || p.type || "").toString().toLowerCase();
      const n = (p.NAME || p.NAME_1 || p.name || "").toString().toLowerCase();
      return t.includes("lake") || n.includes("lake");
    }
    const features = geoData.features || [];
    const lakes = features.filter(isLake);
    const districts = features.filter(f => !isLake(f));

    // Add SVG filter definition for pulse effect
    svg.append("defs").html(`
      <filter id="pulseEffect" x="-20%" y="-20%" width="140%" height="140%">
        <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="blur" />
        <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="pulse" />
        <feBlend in="SourceGraphic" in2="pulse" mode="screen" />
      </filter>
    `);

    // 5) draw lakes first
    lakeSelection = mapGroup.append("g").attr("class","lakes")
      .selectAll("path")
      .data(lakes)
      .enter()
      .append("path")
      .attr("class","lake")
      .attr("d", path);

    // 6) draw districts
    districtSelection = mapGroup.append("g").attr("class","districts")
      .selectAll("path")
      .data(districts)
      .enter()
      .append("path")
      .attr("class","district")
      .attr("d", path)
      .attr("fill", d => {
        const dname = normalizeName(featureDistrictName(d));
        const yearData = allElectionData[currentYear] || { electionData: {} };
        return (yearData.electionData[dname] ? yearData.electionData[dname].color : "#f5f5f5"); // Lighter gray for empty districts
      })
      .on("click", onDistrictClick)
      .on("mouseover", function(event, d){
        d3.select(this).raise();
        d3.select(this).classed("focused", true);
      })
      .on("mouseout", function(event, d){
        // do not remove focus if it's the selected one
        const id = d.id || (d.properties && (d.properties.id || d.properties.NAME_1 || d.properties.DISTRICT)) || null;
        if(selectedFeatureId !== id) d3.select(this).classed("focused", false);
      });

    // 7) Add district labels
    labelSelection = mapGroup.append("g").attr("class", "district-labels")
      .selectAll("text")
      .data(districts)
      .enter()
      .append("text")
      .attr("class", "district-label")
      .attr("transform", d => {
        // Use centroid for label placement
        const centroid = path.centroid(d);
        return `translate(${centroid[0]}, ${centroid[1]})`;
      })
      .attr("dy", "0.35em") // Vertical alignment
      .text(d => {
        const districtName = featureDistrictName(d);
        return getDistrictAbbreviation(districtName);
      });

    // 8) initialize zoom
    initZoom();

    // 9) set up keyboard controls
    setupKeyboardControls();
    updateKeyboardHint(); // Set initial hint text

    // 10) initial UI state
    d3.select("#page-title").text(`Malawi Presidential Election — ${currentYear}`);

    // 11) update stats panels
    updateStatsPanels(currentYear);

    // 12) global click on background resets (click on svg not on district)
    svg.on("click", (event) => {
      // if clicked directly on svg (not a path), reset
      const target = event.target;
      if(target && target.tagName && target.tagName.toLowerCase() === 'svg'){
        resetView();
      }
    });

    // 13) handle window resize: recompute projection and update paths
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        updateProjection();
        svg.selectAll("path").attr("d", path);
        
        // Update label positions
        labelSelection.attr("transform", d => {
          const centroid = path.centroid(d);
          return `translate(${centroid[0]}, ${centroid[1]})`;
        });
      }, 250);
    });

    // 14) populate year dropdown (UI)
    buildYearList();

    // 15) helper: updateMapForYear initial
    updateMapForYear(currentYear);

    // 16) Add Likoma button event listener
    document.getElementById('likoma-button').addEventListener('click', focusOnLikoma);

    // Hide loading indicator
    loadingIndicator.style("display", "none");
    
    console.log("Map loaded.");
  } catch(err){
    console.error("Initialization error:", err);
    alert("Error loading map or data. Check console for details.");
    loadingIndicator.style("display", "none");
  }

  // ---------- Helpers ----------

  // build year list UI (re-run safe)
  function buildYearList(){
    yearDropdown.selectAll("*").remove();
    years.forEach(y => {
      const btn = yearDropdown.append("button")
        .attr("type","button")
        .text(y)
        .classed("active", y === currentYear)
        .on("click", function(){
          setYear(y);
        });
    });
    
    // Add keyboard mode selector at the bottom
    const modeSection = yearDropdown.append("div")
      .attr("class", "keyboard-mode");
      
    modeSection.append("label")
      .text("Keyboard Input Mode:");
      
    const modeOptions = modeSection.append("div")
      .attr("class", "keyboard-mode-options");
      
    modeOptions.append("button")
      .attr("type", "button")
      .classed("active", keyboardMode === "numbers")
      .text("Number keys 1-8")
      .on("click", function() {
        setKeyboardMode("numbers");
        hideYearDropdown();
      });
      
    modeOptions.append("button")
      .attr("type", "button")
      .classed("active", keyboardMode === "digits")
      .text("Type last 2 digits (e.g., '99' for 1999)")
      .on("click", function() {
        setKeyboardMode("digits");
        hideYearDropdown();
      });
  }

})(); // IIFE end

</script>
</body>
</html>
